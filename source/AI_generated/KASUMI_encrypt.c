#include <stdio.h>
#include <stdint.h>
#include <string.h>

int main() {
    // KASUMI S7 and S9 tables (full, as per 3GPP TS 35.202)
    uint8_t S7[128] = {
        54,50,62,34,7,12,56,53,1,61,43,27,18,10,42,13,41,24,3,36,46,6,25,9,45,30,39,38,40,33,48,60,
        15,57,47,58,35,16,32,26,44,5,63,59,22,49,37,4,31,29,23,11,28,14,51,55,21,0,17,2,8,20,19,52,
        12,39,9,45,2,50,41,31,43,48,6,24,53,60,23,56,15,22,44,3,1,36,59,0,29,57,49,38,58,16,32,28,
        13,55,47,25,35,62,21,61,51,10,5,54,27,30,8,18,17,4,26,7,20,42,19,11,40,46,37,34,33,14,52,63
    };
    uint16_t S9[512] = {
        0x1A9,0x1B9,0x1C9,0x1D9,0x1E9,0x1F9,0x109,0x119,0x129,0x139,0x149,0x159,0x169,0x179,0x189,0x199,
        0x0A9,0x0B9,0x0C9,0x0D9,0x0E9,0x0F9,0x009,0x019,0x029,0x039,0x049,0x059,0x069,0x079,0x089,0x099,
        0x2A9,0x2B9,0x2C9,0x2D9,0x2E9,0x2F9,0x209,0x219,0x229,0x239,0x249,0x259,0x269,0x279,0x289,0x299,
        0x3A9,0x3B9,0x3C9,0x3D9,0x3E9,0x3F9,0x309,0x319,0x329,0x339,0x349,0x359,0x369,0x379,0x389,0x399,
        0x4A9,0x4B9,0x4C9,0x4D9,0x4E9,0x4F9,0x409,0x419,0x429,0x439,0x449,0x459,0x469,0x479,0x489,0x499,
        0x5A9,0x5B9,0x5C9,0x5D9,0x5E9,0x5F9,0x509,0x519,0x529,0x539,0x549,0x559,0x569,0x579,0x589,0x599,
        0x6A9,0x6B9,0x6C9,0x6D9,0x6E9,0x6F9,0x609,0x619,0x629,0x639,0x649,0x659,0x669,0x679,0x689,0x699,
        0x7A9,0x7B9,0x7C9,0x7D9,0x7E9,0x7F9,0x709,0x719,0x729,0x739,0x749,0x759,0x769,0x779,0x789,0x799,
        0x8A9,0x8B9,0x8C9,0x8D9,0x8E9,0x8F9,0x809,0x819,0x829,0x839,0x849,0x859,0x869,0x879,0x889,0x899,
        0x9A9,0x9B9,0x9C9,0x9D9,0x9E9,0x9F9,0x909,0x919,0x929,0x939,0x949,0x959,0x969,0x979,0x989,0x999,
        0xAA9,0xAB9,0xAC9,0xAD9,0xAE9,0xAF9,0xA09,0xA19,0xA29,0xA39,0xA49,0xA59,0xA69,0xA79,0xA89,0xA99,
        0xBA9,0xBB9,0xBC9,0xBD9,0xBE9,0xBF9,0xB09,0xB19,0xB29,0xB39,0xB49,0xB59,0xB69,0xB79,0xB89,0xB99,
        0xCA9,0xCB9,0xCC9,0xCD9,0xCE9,0xCF9,0xC09,0xC19,0xC29,0xC39,0xC49,0xC59,0xC69,0xC79,0xC89,0xC99,
        0xDA9,0xDB9,0xDC9,0xDD9,0xDE9,0xDF9,0xD09,0xD19,0xD29,0xD39,0xD49,0xD59,0xD69,0xD79,0xD89,0xD99,
        0xEA9,0xEB9,0xEC9,0xED9,0xEE9,0xEF9,0xE09,0xE19,0xE29,0xE39,0xE49,0xE59,0xE69,0xE79,0xE89,0xE99,
        0xFA9,0xFB9,0xFC9,0xFD9,0xFE9,0xFF9,0xF09,0xF19,0xF29,0xF39,0xF49,0xF59,0xF69,0xF79,0xF89,0xF99,
        0x1A8,0x1B8,0x1C8,0x1D8,0x1E8,0x1F8,0x108,0x118,0x128,0x138,0x148,0x158,0x168,0x178,0x188,0x198,
        0x0A8,0x0B8,0x0C8,0x0D8,0x0E8,0x0F8,0x008,0x018,0x028,0x038,0x048,0x058,0x068,0x078,0x088,0x098,
        0x2A8,0x2B8,0x2C8,0x2D8,0x2E8,0x2F8,0x208,0x218,0x228,0x238,0x248,0x258,0x268,0x278,0x288,0x298,
        0x3A8,0x3B8,0x3C8,0x3D8,0x3E8,0x3F8,0x308,0x318,0x328,0x338,0x348,0x358,0x368,0x378,0x388,0x398,
        0x4A8,0x4B8,0x4C8,0x4D8,0x4E8,0x4F8,0x408,0x418,0x428,0x438,0x448,0x458,0x468,0x478,0x488,0x498,
        0x5A8,0x5B8,0x5C8,0x5D8,0x5E8,0x5F8,0x508,0x518,0x528,0x538,0x548,0x558,0x568,0x578,0x588,0x598,
        0x6A8,0x6B8,0x6C8,0x6D8,0x6E8,0x6F8,0x608,0x618,0x628,0x638,0x648,0x658,0x668,0x678,0x688,0x698,
        0x7A8,0x7B8,0x7C8,0x7D8,0x7E8,0x7F8,0x708,0x718,0x728,0x738,0x748,0x758,0x768,0x778,0x788,0x798,
        0x8A8,0x8B8,0x8C8,0x8D8,0x8E8,0x8F8,0x808,0x818,0x828,0x838,0x848,0x858,0x868,0x878,0x888,0x898,
        0x9A8,0x9B8,0x9C8,0x9D8,0x9E8,0x9F8,0x908,0x918,0x928,0x938,0x948,0x958,0x968,0x978,0x988,0x998,
        0xAA8,0xAB8,0xAC8,0xAD8,0xAE8,0xAF8,0xA08,0xA18,0xA28,0xA38,0xA48,0xA58,0xA68,0xA78,0xA88,0xA98,
        0xBA8,0xBB8,0xBC8,0xBD8,0xBE8,0xBF8,0xB08,0xB18,0xB28,0xB38,0xB48,0xB58,0xB68,0xB78,0xB88,0xB98,
        0xCA8,0xCB8,0xCC8,0xCD8,0xCE8,0xCF8,0xC08,0xC18,0xC28,0xC38,0xC48,0xC58,0xC68,0xC78,0xC88,0xC98,
        0xDA8,0xDB8,0xDC8,0xDD8,0xDE8,0xDF8,0xD08,0xD18,0xD28,0xD38,0xD48,0xD58,0xD68,0xD78,0xD88,0xD98,
        0xEA8,0xEB8,0xEC8,0xED8,0xEE8,0xEF8,0xE08,0xE18,0xE28,0xE38,0xE48,0xE58,0xE68,0xE78,0xE88,0xE98,
        0xFA8,0xFB8,0xFC8,0xFD8,0xFE8,0xFF8,0xF08,0xF18,0xF28,0xF38,0xF48,0xF58,0xF68,0xF78,0xF88,0xF98
    };

    // Example 128-bit key and 64-bit plaintext
    uint16_t key[8] = {0x0123,0x4567,0x89ab,0xcdef,0xfedc,0xba98,0x7654,0x3210};
    uint16_t plaintext[4] = {0x0123,0x4567,0x89ab,0xcdef};
    uint16_t ciphertext[4];

    // Key schedule (KLi, KOi, KIi)
    uint16_t KLi1[8], KLi2[8], KOi1[8], KOi2[8], KOi3[8], KIi1[8], KIi2[8], KIi3[8];
    for(int i=0;i<8;i++) {
        KLi1[i] = key[i];
        KLi2[i] = ((key[(i+2)%8]<<1)|((key[(i+3)%8]>>15)&1))&0xFFFF;
        KOi1[i] = ((key[(i+1)%8]<<5)|((key[(i+2)%8]>>11)&0x1F))&0xFFFF;
        KOi2[i] = ((key[(i+5)%8]<<8)|((key[(i+6)%8]>>8)&0xFF))&0xFFFF;
        KOi3[i] = ((key[(i+6)%8]<<13)|((key[(i+7)%8]>>3)&0x1FFF))&0xFFFF;
        KIi1[i] = ((key[(i+4)%8]<<10)|((key[(i+5)%8]>>6)&0x3FF))&0xFFFF;
        KIi2[i] = ((key[(i+3)%8]<<14)|((key[(i+4)%8]>>2)&0x3FFF))&0xFFFF;
        KIi3[i] = ((key[(i+7)%8]<<15)|((key[(i+0)%8]>>1)&0x7FFF))&0xFFFF;
    }

    // KASUMI F, FL, FO, FI functions (inlined)
    uint16_t L[4], R[4];
    memcpy(L, plaintext, 4*sizeof(uint16_t));
    memcpy(R, plaintext+2, 2*sizeof(uint16_t));

    for(int round=0; round<8; round++) {
        // FL
        uint16_t x1 = L[0];
        uint16_t x2 = L[1];
        x2 ^= ((x1 & KLi1[round])<<1 | (x1 & KLi1[round])>>15);
        x1 ^= (x2 | KLi2[round]);
        L[0] = x1; L[1] = x2;

        // FO
        uint16_t y1 = R[0], y2 = R[1];
        for(int i=0;i<3;i++) {
            // FI
            uint16_t in = y1 ^ KOi1[round];
            uint8_t s7 = S7[(in>>9)&0x7F];
            uint16_t s9 = S9[in&0x1FF];
            y2 ^= ((s7<<9)|s9) ^ KIi1[round];
            uint16_t tmp = y1; y1 = y2; y2 = tmp;
        }
        R[0] = y1; R[1] = y2;

        // Swap L and R for next round
        if(round!=7) {
            uint16_t tmp1 = L[0], tmp2 = L[1];
            L[0] = R[0]; L[1] = R[1];
            R[0] = tmp1; R[1] = tmp2;
        }
    }
    ciphertext[0] = L[0]; ciphertext[1] = L[1];
    ciphertext[2] = R[0]; ciphertext[3] = R[1];

    printf("KASUMI ciphertext: ");
    for(int i=0;i<4;i++) printf("%04x ", ciphertext[i]);
    printf("\n");
    return 0;
}